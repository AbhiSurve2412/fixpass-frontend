<div class="profile-container">
  <div class="profile-header">
    <button mat-icon-button (click)="closeProfilDrawer()">
      <mat-icon>close</mat-icon>
    </button>
  </div>
  @if((isLoading$ | async) === true){
    <div class="spinner-container">
      <mat-progress-spinner
        diameter="60"
        mode="indeterminate">
      </mat-progress-spinner>
    </div>
  }
  <div class="form-container">
    <form [formGroup]="signupForm">
      <div class="form-fields">
        <mat-form-field class="full-width"  [ngClass]="{'disabled-field': !isEditMode()}">
          <mat-label>Name</mat-label>
          <input matInput formControlName="name" required [readonly]="!isEditMode()"/>
          @if (signupForm.get('name')?.hasError('required') && signupForm.get('name')?.touched) {
          <mat-error>Name is required</mat-error>
          }
        </mat-form-field>

        <mat-form-field class="full-width"  [ngClass]="{'disabled-field': !isEditMode()}">
          <mat-label>Email</mat-label>
          <input matInput type="email" formControlName="email" required [readonly]="!isEditMode()"/>
          @if (signupForm.get('email')?.hasError('required') && signupForm.get('email')?.touched) {
          <mat-error>Email is required</mat-error>
          } @if (signupForm.get('email')?.hasError('email') && signupForm.get('email')?.touched) {
          <mat-error>Please enter a valid email address</mat-error>
          }
        </mat-form-field>

        <mat-form-field class="full-width"  [ngClass]="{'disabled-field': !isEditMode()}">
          <mat-label>College Name</mat-label>
          @if (isEditMode()) {
          <input matInput type="text" formControlName="college" [matAutocomplete]="autoCollege" required />
          <mat-autocomplete #autoCollege="matAutocomplete" [displayWith]="displayCollegeFn">
            @if ((filteredColleges | async)?.length === 0) {
            <mat-option disabled>No colleges found</mat-option>
            } @for (college of filteredColleges | async; track college.collegeId) {
            <mat-option [value]="college">
              {{ college.name }}
            </mat-option>
            }
          </mat-autocomplete>
          } @else {
          <input matInput type="text"  readonly
          [value]="displayCollegeFn(signupForm.get('college')?.value)"/>
          }
          @if (signupForm.get('college')?.hasError('required') && signupForm.get('college')?.touched) {
          <mat-error>College name is required</mat-error>
          }
        </mat-form-field>

        <mat-form-field class="full-width"  [ngClass]="{'disabled-field': !isEditMode()}">
          <mat-label>University</mat-label>
          <input matInput type="text"  readonly
          [value]="displayUniversityFn(signupForm.get('university')?.value)"/>
          <!-- @if (isEditMode()) {
          <input matInput type="text" formControlName="university" [matAutocomplete]="autoUniversity" required />
          <mat-autocomplete #autoUniversity="matAutocomplete" [displayWith]="displayUniversityFn">
            @if ((filteredUniversities | async)?.length === 0) {
            <mat-option disabled>No universities found</mat-option>
            } @for (university of filteredUniversities | async; track university.universityId) {
            <mat-option [value]="university">
              {{ university.name }}
            </mat-option>
            }
          </mat-autocomplete>
          } @else {
          <input matInput type="text"  readonly
            [value]="displayUniversityFn(signupForm.get('university')?.value)"/>
          } -->
          @if (signupForm.get('university')?.hasError('required') && signupForm.get('university')?.touched) {
          <mat-error>University is required</mat-error>
          }
        </mat-form-field>

        <mat-form-field class="full-width"  [ngClass]="{'disabled-field': !isEditMode()}">
          <mat-label>Branch</mat-label>
          <input matInput type="text" readonly [value]="displayBranchFn(signupForm.get('branch')?.value)"/>
          <!-- @if (isEditMode()) {
          <input matInput type="text" formControlName="branch" [matAutocomplete]="autoBranch" required />
          <mat-autocomplete #autoBranch="matAutocomplete" [displayWith]="displayBranchFn">
            @if ((filteredBranches | async)?.length === 0) {
            <mat-option disabled>No branches found</mat-option>
            } @for (branch of filteredBranches | async; track branch.branchId) {
            <mat-option [value]="branch">
              {{ branch.name }}
            </mat-option>
            }
          </mat-autocomplete>
          } @else {
          <input matInput type="text" readonly [value]="displayBranchFn(signupForm.get('branch')?.value)"/>
          } -->
          @if (signupForm.get('branch')?.hasError('required') && signupForm.get('branch')?.touched) {
          <mat-error>Branch is required</mat-error>
          }
        </mat-form-field>

        <div class="two-fields">
          <mat-form-field class="full-width"  [ngClass]="{'disabled-field': !isEditMode()}">
            <mat-label>Semester</mat-label>
            <input matInput type="text" readonly
            [value]="displaySemisterFn(signupForm.get('semester')?.value)"/>
            <!-- @if (isEditMode()) {
            <input matInput type="text" formControlName="semester" [matAutocomplete]="autoSemester" required />
            <mat-autocomplete #autoSemester="matAutocomplete" [displayWith]="displaySemisterFn">
              @if ((filteredSemesters | async)?.length === 0) {
              <mat-option disabled>No semesters found</mat-option>
              }
              @for (semester of filteredSemesters | async; track semester.semesterId) {
              <mat-option [value]="semester">
                {{ semester.name }}
              </mat-option>
              }
            </mat-autocomplete>
            } @else {
            <input matInput type="text" readonly
            [value]="displaySemisterFn(signupForm.get('semester')?.value)"/>
            } -->
            @if (signupForm.get('semester')?.hasError('required') && signupForm.get('semester')?.touched) {
            <mat-error>Semester is required</mat-error>
            }
          </mat-form-field>
          <mat-form-field class="full-width"  [ngClass]="{'disabled-field': !isEditMode()}">
            <mat-label>Year</mat-label>
            <input matInput type="text" readonly [value]="displayYearFn(signupForm.get('year')?.value)" />
            <!-- @if (isEditMode()) {
            <input matInput type="text" formControlName="year" [matAutocomplete]="autoYear" required />
            <mat-autocomplete #autoYear="matAutocomplete" [displayWith]="displayYearFn">
              @if ((filteredYears | async)?.length === 0) {
              <mat-option disabled>No years found</mat-option>
              } @for (year of filteredYears | async; track year.yearId) {
              <mat-option [value]="year">
                {{ year.name }}
              </mat-option>
              }
            </mat-autocomplete>
            } @else {
            <input matInput type="text" readonly [value]="displayYearFn(signupForm.get('year')?.value)" />
            } -->
            @if (signupForm.get('year')?.hasError('required') && signupForm.get('year')?.touched) {
            <mat-error>Year is required</mat-error>
            }
          </mat-form-field>
        </div>
      </div>
      <div class="form-actions">
        @if(isEditMode()){
        <button mat-raised-button class="secondary-btn" type="button" (click)="setEditMode()">Cancel</button>
        <button mat-stroked-button class="primary-btn" type='submit' (click)="updateProfile()">
          Submit
        </button>
        }
        @else{
        <button mat-raised-button class="secondary-btn" type="button" (click)="closeProfilDrawer()">Close</button>
        <button mat-stroked-button class="primary-btn" type='button' (click)="setEditMode()">
          Edit
        </button>
        }
      </div>
    </form>
  </div>
</div>